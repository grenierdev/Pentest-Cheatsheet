# SMTP

Ports: `25 (TCP), 465 (TCP), 587 (TCP), 2525 (TCP)`

## NMAP scan
```sh
┌──(grenierdev㉿kali)-[~]
└─$ sudo nmap -n -sS -T3 --reason 10.11.1.0/24 -p25,465,587,2525 --open -oG - | grep "Ports: " | awk '{print $2}' | tee smtphosts
```

## Verify user (python)
```python
#!/usr/bin/python

import socket
import sys

if len(sys.argv) != 4:
	print("Usage: smtpverify.py <host> <port> <username>")
	sys.exit(0)

GRAY='\033[1;30m'
RESET='\033[0m'

host = sys.argv[1]
port = int(sys.argv[2])
list = sys.argv[3]

try:
	handle = open(list, "rb")
	lines = handle.readlines()
	print(f"{GRAY}Verifying list {list} on {host}:{port}{RESET}", file=sys.stderr)
except:
	lines = [list.encode()]
	print(f"{GRAY}Verifying if {host}:{port} has {list}{RESET}", file=sys.stderr)

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
conn = sock.connect((host, port))
banner = sock.recv(1024)
print(f"{GRAY}  {banner}{RESET}", file=sys.stderr)

for line in lines:
	username = line.decode("utf-8").strip()
	for retry in range(2):
		try:
			sock.send(f'VRFY {username}\r\n'.encode())
			result = sock.recv(1024)
			print(f"{GRAY}  {result}{RESET}", file=sys.stderr)
			if result[0:3] == b'250':
				print(f"Host {host}:{port} has {username}")
			break
		except:
			sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
			conn = sock.connect((host, port))
			banner = sock.recv(1024)
			print(f"{GRAY}  {banner}{RESET}", file=sys.stderr)
```
```sh
┌──(grenierdev㉿kali)-[~]
└─$ smtpverify.py 10.11.1.115 25 nobody
\033[1;30mVerifying if 10.11.1.115:25 has nobody
  b'220 tophat.acme.com ESMTP Sendmail 8.12.8/8.12.8; Wed, 16 Mar 2022 16:24:24 +0200\r\n'
  b'250 2.1.5 <nobody@tophat.acme.com>\r\n'
Host 10.11.1.115:25 has nobody

┌──(grenierdev㉿kali)-[~]
└─$ ./smtpverify.py 10.11.1.115 25 /usr/share/seclists/Usernames/top-usernames-shortlist.txt
Verifying list /usr/share/seclists/Usernames/top-usernames-shortlist.txt on 10.11.1.115:25
  b'220 tophat.acme.com ESMTP Sendmail 8.12.8/8.12.8; Wed, 16 Mar 2022 16:44:10 +0200\r\n'
  b'250 2.1.5 root <root@tophat.acme.com>\r\n'
Host 10.11.1.115:25 has root
  b'550 5.1.1 admin... User unknown\r\n'
  b'550 5.1.1 test... User unknown\r\n'
  b'550 5.1.1 guest... User unknown\r\n'
  b'550 5.1.1 info... User unknown\r\n'
  b'250 2.1.5 <adm@tophat.acme.com>\r\n'
Host 10.11.1.115:25 has adm
  b'250 2.1.5 <mysql@tophat.acme.com>\r\n'
Host 10.11.1.115:25 has mysql
  b'550 5.1.1 user... User unknown\r\n'
  b'550 5.1.1 administrator... User unknown\r\n'
  b'550 5.1.1 oracle... User unknown\r\n'
  b'250 2.1.5 <ftp@tophat.acme.com>\r\n'
Host 10.11.1.115:25 has ftp
  b'550 5.1.1 pi... User unknown\r\n'
  b'550 5.1.1 puppet... User unknown\r\n'
  b'550 5.1.1 ansible... User unknown\r\n'
  b'550 5.1.1 ec2-user... User unknown\r\n'
  b'550 5.1.1 vagrant... User unknown\r\n'
  b'550 5.1.1 azureuser... User unknown\r\n'
```